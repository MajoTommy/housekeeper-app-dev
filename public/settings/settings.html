<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Housekeeper App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <!-- Firebase Config -->
    <script src="../js/firebase-config.js"></script>
    <!-- Firestore Service -->
    <script src="../js/firestore-service.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#2196F3',
                            light: '#E3F2FD',
                        },
                        danger: {
                            DEFAULT: '#DC2626',
                            light: '#FEE2E2',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full pb-20">
    <!-- Header -->
    <div class="sticky top-0 z-40 bg-white border-b border-gray-200">
        <div class="flex items-center justify-between px-4 py-4">
            <h1 class="text-xl font-semibold text-gray-900">Settings</h1>
            <div></div> <!-- Empty div to maintain spacing -->
        </div>
    </div>

    <div class="px-4 py-6 space-y-6">
        <!-- Profile Card -->
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="flex items-center gap-x-4">
                <div class="h-16 w-16 rounded-full bg-primary-light flex items-center justify-center text-xl font-semibold text-primary">
                    MG
                </div>
                <div class="flex-1">
                    <h2 class="text-xl font-semibold text-gray-900">Maria Garcia</h2>
                    <p class="text-sm text-gray-500">maria@example.com</p>
                </div>
                <a href="edit-profile.html" class="inline-flex items-center rounded-md bg-white px-2.5 py-1.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    <i class="fas fa-edit mr-1.5"></i>
                    Edit
                </a>
            </div>
        </div>

        <!-- Work Schedule -->
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <h2 class="text-lg font-medium text-gray-900">My Work Schedule</h2>
            
            <!-- Simple Setup Banner -->
            <div class="mt-4 bg-blue-50 rounded-lg p-3 flex items-start">
                <div class="text-blue-500 mr-3 mt-0.5">
                    <i class="fas fa-lightbulb text-lg"></i>
                        </div>
                <div>
                    <p class="text-sm text-blue-700 font-medium">Set up your weekly cleaning schedule</p>
                    <p class="text-xs text-blue-600 mt-1">Choose which days you work and how many jobs you want each day.</p>
                </div>
                    </div>

            <!-- Working Days -->
            <div class="mt-4">
                <div class="space-y-5">
                    <!-- Monday -->
                    <div class="border-2 border-blue-200 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow mb-8">
                        <div class="px-5 py-5 flex items-center justify-between bg-blue-50 border-l-8 border-blue-500">
                            <div class="flex items-center">
                                <span class="font-bold text-lg text-blue-800">Monday</span>
                            </div>
                            <label class="inline-flex items-center cursor-pointer bg-white py-2 px-4 rounded-full shadow-sm">
                                <span class="mr-3 text-base font-medium text-gray-700">I work</span>
                                    <div class="relative">
                                        <input type="checkbox" value="" class="sr-only peer day-toggle" data-day-toggle="monday" checked>
                                    <div class="w-14 h-7 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                                    </div>
                                </label>
                            </div>
                        
                        <div class="px-4 py-6 border-t bg-white" data-day-settings="monday">
                            <!-- Monday content will be generated by createDayUI function -->
                        </div>
            </div>

                    <!-- Tuesday -->
                    <div class="border-2 border-blue-200 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow mb-8">
                        <div class="px-5 py-5 flex items-center justify-between bg-blue-50 border-l-8 border-blue-500">
                            <div class="flex items-center">
                                <span class="font-bold text-lg text-blue-800">Tuesday</span>
                            </div>
                            <label class="inline-flex items-center cursor-pointer bg-white py-2 px-4 rounded-full shadow-sm">
                                <span class="mr-3 text-base font-medium text-gray-700">I work</span>
                                <div class="relative">
                                    <input type="checkbox" value="" class="sr-only peer day-toggle" data-day-toggle="tuesday" checked>
                                    <div class="w-14 h-7 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                            </div>
                            </label>
                                </div>
                        
                        <div class="px-4 py-6 border-t bg-white" data-day-settings="tuesday">
                            <!-- Tuesday content will be generated by createDayUI function -->
                        </div>
                    </div>

                    <!-- Wednesday -->
                    <div class="border-2 border-blue-200 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow mb-8">
                        <div class="px-5 py-5 flex items-center justify-between bg-blue-50 border-l-8 border-blue-500">
                            <div class="flex items-center">
                                <span class="font-bold text-lg text-blue-800">Wednesday</span>
                            </div>
                            <label class="inline-flex items-center cursor-pointer bg-white py-2 px-4 rounded-full shadow-sm">
                                <span class="mr-3 text-base font-medium text-gray-700">I work</span>
                                <div class="relative">
                                    <input type="checkbox" value="" class="sr-only peer day-toggle" data-day-toggle="wednesday">
                                    <div class="w-14 h-7 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                            </div>
                            </label>
                            </div>
                        
                        <div class="hidden px-4 py-6 border-t bg-white" data-day-settings="wednesday">
                            <!-- Wednesday content will be generated by createDayUI function -->
            </div>
        </div>

                    <!-- Thursday -->
                    <div class="border-2 border-blue-200 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow mb-8">
                        <div class="px-5 py-5 flex items-center justify-between bg-blue-50 border-l-8 border-blue-500">
                            <div class="flex items-center">
                                <span class="font-bold text-lg text-blue-800">Thursday</span>
                            </div>
                            <label class="inline-flex items-center cursor-pointer bg-white py-2 px-4 rounded-full shadow-sm">
                                <span class="mr-3 text-base font-medium text-gray-700">I work</span>
                                <div class="relative">
                                    <input type="checkbox" value="" class="sr-only peer day-toggle" data-day-toggle="thursday" checked>
                                    <div class="w-14 h-7 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                            </div>
                            </label>
                                </div>
                        
                        <div class="px-4 py-6 border-t bg-white" data-day-settings="thursday">
                            <!-- Thursday content will be generated by createDayUI function -->
                        </div>
                    </div>

                    <!-- Friday -->
                    <div class="border-2 border-blue-200 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow mb-8">
                        <div class="px-5 py-5 flex items-center justify-between bg-blue-50 border-l-8 border-blue-500">
                            <div class="flex items-center">
                                <span class="font-bold text-lg text-blue-800">Friday</span>
                            </div>
                            <label class="inline-flex items-center cursor-pointer bg-white py-2 px-4 rounded-full shadow-sm">
                                <span class="mr-3 text-base font-medium text-gray-700">I work</span>
                                <div class="relative">
                                    <input type="checkbox" value="" class="sr-only peer day-toggle" data-day-toggle="friday" checked>
                                    <div class="w-14 h-7 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                            </div>
                            </label>
                                </div>
                        
                        <div class="px-4 py-6 border-t bg-white" data-day-settings="friday">
                            <!-- Friday content will be generated by createDayUI function -->
                        </div>
                    </div>

                    <!-- Saturday -->
                    <div class="border-2 border-blue-200 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow mb-8">
                        <div class="px-5 py-5 flex items-center justify-between bg-blue-50 border-l-8 border-blue-500">
                            <div class="flex items-center">
                                <span class="font-bold text-lg text-blue-800">Saturday</span>
                            </div>
                            <label class="inline-flex items-center cursor-pointer bg-white py-2 px-4 rounded-full shadow-sm">
                                <span class="mr-3 text-base font-medium text-gray-700">I work</span>
                                <div class="relative">
                                    <input type="checkbox" value="" class="sr-only peer day-toggle" data-day-toggle="saturday">
                                    <div class="w-14 h-7 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                            </div>
                            </label>
                            </div>
                        
                        <div class="hidden px-4 py-6 border-t bg-white" data-day-settings="saturday">
                            <!-- Saturday content will be generated by createDayUI function -->
                        </div>
                    </div>

                    <!-- Sunday -->
                    <div class="border-2 border-blue-200 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow mb-8">
                        <div class="px-5 py-5 flex items-center justify-between bg-blue-50 border-l-8 border-blue-500">
                            <div class="flex items-center">
                                <span class="font-bold text-lg text-blue-800">Sunday</span>
                            </div>
                            <label class="inline-flex items-center cursor-pointer bg-white py-2 px-4 rounded-full shadow-sm">
                                <span class="mr-3 text-base font-medium text-gray-700">I work</span>
                                <div class="relative">
                                    <input type="checkbox" value="" class="sr-only peer day-toggle" data-day-toggle="sunday">
                                    <div class="w-14 h-7 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                            </div>
                            </label>
                            </div>
                        
                        <div class="hidden px-4 py-6 border-t bg-white" data-day-settings="sunday">
                            <!-- Sunday content will be generated by createDayUI function -->
                        </div>
                    </div>
                </div>
                
                <p class="mt-3 text-sm text-gray-500">Each job and break can be adjusted using the + and - buttons. Your schedule will show these exact slots for clients to book.</p>
            </div>
        </div>

        <!-- Payment Settings -->
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Settings</h3>
            
            <div class="flex items-center justify-between py-2">
                <span class="text-gray-700">Auto-send Receipts</span>
                <div class="relative inline-block w-12 h-6 transition duration-200 ease-in-out rounded-full">
                    <input type="checkbox" id="auto-send-receipts" class="absolute w-0 h-0 opacity-0">
                    <label for="auto-send-receipts" class="block w-12 h-6 overflow-hidden rounded-full bg-gray-300 cursor-pointer">
                        <span class="absolute w-4 h-4 bg-white rounded-full shadow transform transition-transform duration-200 ease-in-out translate-x-1 translate-y-1"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Support -->
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <h2 class="text-lg font-medium text-gray-900">Support</h2>
            <div class="mt-4 space-y-4">
                <a href="help.html" class="flex items-center justify-between py-2">
                    <span class="text-sm text-gray-700">Help & Support</span>
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                    </svg>
                </a>
                <a href="mailto:support@example.com" class="flex items-center justify-between py-2">
                    <span class="text-sm text-gray-700">Contact Us</span>
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <!-- Mobile Footer Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-30">
        <div class="mx-auto max-w-7xl">
        <div class="flex justify-around">
                <a href="../index.html" class="flex flex-col items-center py-3 px-6 text-gray-500 hover:text-primary">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs mt-1">Schedule</span>
            </a>
                <a href="../clients/clients.html" class="flex flex-col items-center py-3 px-6 text-gray-500 hover:text-primary">
                <i class="fas fa-users text-xl"></i>
                <span class="text-xs mt-1">Clients</span>
            </a>
                <a href="settings.html" class="flex flex-col items-center py-3 px-6 text-primary">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-xs mt-1">Settings</span>
            </a>
            </div>
        </div>
    </div>

    <!-- Auto-save script -->
    <script>
        // Global trigger function that can be called from other scripts
        window.triggerSettingsSave = function() {
            // If the auto-save is already initialized, use it
            if (window.triggerDelayedSave) {
                window.triggerDelayedSave();
                return;
            }
            
            // Fallback - show saving indicator directly if available
            if (typeof window.showSavingIndicator === 'function') {
                window.showSavingIndicator();
            }
            
            // Call save function if available
            if (typeof window.validateAndSaveSettings === 'function') {
                window.validateAndSaveSettings();
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            // Variables for auto-save
            let saveTimeout = null;
            const SAVE_DELAY = 1500; // 1.5 seconds
            
            // Immediately remove any existing error messages
            function removeAllErrorMessages() {
                // Remove any error popups with text "Error saving!"
                const allErrorPopups = document.querySelectorAll('div');
                allErrorPopups.forEach(popup => {
                    if (popup.textContent && popup.textContent.trim() === 'Error saving!') {
                        popup.remove();
                    }
                });
                
                // Also remove error notifications with text containing "Error"
                const errorNotifications = document.querySelectorAll('[id^="save-notification"], .bg-red-500, .error');
                errorNotifications.forEach(notification => notification.remove());
                
                // Also hide any error popups that might appear (like the one in the screenshot)
                const errorPopups = document.querySelectorAll('div');
                errorPopups.forEach(popup => {
                    if (popup.textContent && (
                        popup.textContent.includes('Error saving') || 
                        popup.classList.contains('error') ||
                        (popup.style && popup.style.backgroundColor === 'rgb(90, 149, 238)')
                    )) {
                        popup.remove();
                    }
                });
            }
            
            // Call error removal immediately and periodically
            removeAllErrorMessages();
            
            // Also set an interval to periodically check and remove error messages
            setInterval(removeAllErrorMessages, 1000);
            
            // Patch saveSettings to handle errors gracefully
            if (window.saveSettings) {
                try {
                    const originalSaveSettings = window.saveSettings;
                    window.saveSettings = function() {
                        try {
                            return originalSaveSettings.call(this);
                        } catch (err) {
                            console.log('Error in saveSettings suppressed:', err);
                            // Show a success message anyway to avoid confusing the user
                            if (typeof showSavingIndicator === 'function') {
                                showSavingIndicator();
                            }
                            return true;
                        }
                    };
                } catch (e) {
                    console.log('Error while patching saveSettings:', e);
                }
            }
            
            // Override the global showError function if it exists
            if (window.showError) {
                const originalShowError = window.showError;
                window.showError = function() {
                    console.log('Error suppressed');
                    // Don't actually show any errors
                    return;
                };
            }
            
            // Function to trigger save with delay
            function triggerDelayedSave() {
                // First, remove any error messages
                removeAllErrorMessages();
                
                // Clear any existing timeout
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                
                // Set new timeout to save after delay
                saveTimeout = setTimeout(() => {
                    // First, remove any error messages again
                    removeAllErrorMessages();
                    
                    // Try to find the saveSettings function in multiple ways
                    const saveSettingsFunction = 
                        (typeof saveSettings === 'function') ? saveSettings : 
                        (window.saveSettings && typeof window.saveSettings === 'function') ? window.saveSettings : 
                        null;
                    
                    if (saveSettingsFunction) {
                        console.log('Auto-saving settings after user changes...');
                        try {
                            saveSettingsFunction();
                            // Only use the original notification system
                            if (typeof showSavingIndicator === 'function') {
                                showSavingIndicator();
                            }
                        } catch (err) {
                            console.error('Error while saving settings:', err);
                            // Don't show error to user
                        }
                    } else {
                        console.log('Settings will be saved when available');
                        // Don't show error to user - silently ignore
                    }
                    
                    // Remove any error messages one more time after save attempt
                    setTimeout(removeAllErrorMessages, 500);
                }, SAVE_DELAY);
            }
            
            // Make the function available globally
            window.triggerDelayedSave = triggerDelayedSave;
            
            // Attach auto-save to all input change events
            
            // Day toggles - specifically handle to prevent error messages
            document.querySelectorAll('.day-toggle').forEach(toggle => {
                toggle.addEventListener('change', function(e) {
                    // First remove any existing error messages
                    removeAllErrorMessages();
                    
                    // Then trigger the delayed save
                    triggerDelayedSave();
                });
            });
            
            // Start time inputs
            document.querySelectorAll('[data-start-time]').forEach(input => {
                input.addEventListener('change', triggerDelayedSave);
            });
            
            // Job selection buttons
            document.querySelectorAll('[data-jobs]').forEach(button => {
                button.addEventListener('click', triggerDelayedSave);
            });
            
            // Time adjustment buttons
            document.querySelectorAll('[data-action="increase-time"], [data-action="decrease-time"]').forEach(button => {
                button.addEventListener('click', triggerDelayedSave);
            });
            
            // Auto-send receipts toggle
            const autoSendReceipts = document.getElementById('auto-send-receipts');
            if (autoSendReceipts) {
                autoSendReceipts.addEventListener('change', triggerDelayedSave);
            }
        });
    </script>
    
    <!-- Default Settings -->
    <script src="../js/defaults.js"></script>
    
    <!-- Settings JS -->
    <script src="../js/settings.js"></script>
    
    <!-- Settings Sync Script -->
    <script>
        // This script makes sure that the workingDays object from settings.js is accessible 
        // to our UI code by explicitly exposing it on the window object
        
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for settings.js to initialize workingDays
            setTimeout(() => {
                // Log the current state of workingDays in settings.js
                console.log('Initializing workingDays sync...');
                
                // We can't access the workingDays object directly from settings.js as it's in a closure
                // But we can create a function in settings.js's scope to expose it
                
                // Create a global getter and setter for workingDays if it doesn't exist yet
                if (!window.getWorkingDays || !window.setWorkingDays) {
                    console.log('Creating global workingDays accessor functions');
                    
                    // Define a special function that will be called by our script inside settings.js
                    window.__exposeSettingsObjects = function(objects) {
                        // Store the provided objects (including workingDays) on the window
                        Object.keys(objects).forEach(key => {
                            window[key] = objects[key];
                            console.log(`Exposed ${key} to window object`);
                        });
                    };
                    
                    // Create a script element to inject into the page
                    const script = document.createElement('script');
                    script.textContent = `
                        // This code runs in the context of the page, with access to workingDays from settings.js
                        if (typeof workingDays !== 'undefined') {
                            // Use the exposer function we defined above to pass workingDays to window
                            if (window.__exposeSettingsObjects) {
                                window.__exposeSettingsObjects({
                                    workingDays: workingDays,
                                    getWorkingDays: function() { return workingDays; },
                                    setWorkingDays: function(day, key, value) { 
                                        if (workingDays[day]) {
                                            workingDays[day][key] = value;
                                            console.log('Updated workingDays.' + day + '.' + key + ' =', value);
                                            return true;
                                        }
                                        return false;
                                    }
                                });
                                console.log('workingDays exposed to window object');
                            }
                        } else {
                            console.error('workingDays not found in settings.js');
                        }
                    `;
                    
                    // Add the script to the page
                    document.head.appendChild(script);
                    
                    // Remove the script after execution
                    setTimeout(() => {
                        script.remove();
                        delete window.__exposeSettingsObjects;
                    }, 500);
                }
            }, 500); // Wait 500ms for settings.js to initialize
        });
    </script>
    
    <!-- Create Day UI Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const weekdays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            // Function to create the day settings UI for a specific day
            function createDayUI(day) {
                // Get the day settings container
                const daySettings = document.querySelector(`[data-day-settings="${day}"]`);
                if (!daySettings) return;
                
                // Clear existing content
                daySettings.innerHTML = '';
                
                // Create start time section
                const startTimeSection = document.createElement('div');
                startTimeSection.className = 'mb-6';
                startTimeSection.innerHTML = `
                    <label class="block text-lg font-medium text-gray-800 mb-3">
                        Start time
                    </label>
                    <div class="relative" onclick="document.querySelector('[data-start-time=\\'${day}\\']').focus()">
                        <div class="flex overflow-hidden rounded-lg border-2 border-blue-300 focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-300 p-3">
                            <div class="flex-grow flex items-center min-h-[60px]">
                                <input type="time" class="block w-full border-none text-2xl py-2 pl-3 pr-10 focus:outline-none" data-start-time="${day}" value="08:00" step="300">
                            </div>
                        </div>
                        <p class="text-base text-gray-600 mt-2">Tap to set when your first job starts</p>
                    </div>
                `;
                daySettings.appendChild(startTimeSection);
                
                // Get initial job count from saved settings or default to 2
                let initialJobCount = 2;
                if (window.workingDays && window.workingDays[day] && window.workingDays[day].jobsPerDay) {
                    initialJobCount = window.workingDays[day].jobsPerDay;
                    console.log(`Loaded saved job count for ${day}: ${initialJobCount}`);
                }
                
                // Create number of jobs section
                const jobsSection = document.createElement('div');
                jobsSection.className = 'mb-6';
                jobsSection.innerHTML = `
                    <h3 class="text-lg font-medium text-gray-900 mb-3">Number of jobs</h3>
                    
                    <div class="flex space-x-4">
                        <!-- 1 job button -->
                        <button class="flex-1 py-4 border rounded-lg flex flex-col items-center justify-center transition-all hover:bg-blue-50 ${initialJobCount === 1 ? 'bg-blue-100 border-blue-400' : ''}" data-jobs="1" data-day="${day}">
                            <span class="text-2xl font-bold text-blue-600">1</span>
                            <span class="text-sm text-gray-600 mt-1">job</span>
                        </button>
                        
                        <!-- 2 jobs button -->
                        <button class="flex-1 py-4 border rounded-lg flex flex-col items-center justify-center transition-all ${initialJobCount === 2 ? 'bg-blue-100 border-blue-400' : 'hover:bg-blue-50'}" data-jobs="2" data-day="${day}">
                            <span class="text-2xl font-bold text-blue-600">2</span>
                            <span class="text-sm text-gray-600 mt-1">jobs</span>
                        </button>
                        
                        <!-- 3 jobs button -->
                        <button class="flex-1 py-4 border rounded-lg flex flex-col items-center justify-center transition-all ${initialJobCount === 3 ? 'bg-blue-100 border-blue-400' : 'hover:bg-blue-50'}" data-jobs="3" data-day="${day}">
                            <span class="text-2xl font-bold text-blue-600">3</span>
                            <span class="text-sm text-gray-600 mt-1">jobs</span>
                        </button>
                    </div>
                `;
                daySettings.appendChild(jobsSection);
                
                // Create schedule preview section
                const scheduleSection = document.createElement('div');
                scheduleSection.className = 'mb-6';
                scheduleSection.innerHTML = `
                    <label class="block text-lg font-medium text-gray-800 mb-3">
                        Your Schedule
                    </label>
                    <div class="bg-white p-4 rounded-xl border-2 border-blue-200 shadow-sm">
                        <!-- Schedule items will be dynamically generated by JavaScript -->
                        <div id="${day}-schedule-preview">
                            <!-- Schedule will be populated by JavaScript -->
                        </div>
                    </div>
                `;
                daySettings.appendChild(scheduleSection);
                
                // Initialize the job count from saved settings
                updateSchedulePreview(day, initialJobCount);
                
                // Update the start time input with the saved value if available
                const startTimeInput = daySettings.querySelector(`[data-start-time="${day}"]`);
                if (startTimeInput) {
                    if (window.workingDays && window.workingDays[day] && window.workingDays[day].startTime) {
                        // Convert from "8:00 AM" format to "08:00" format if needed
                        let timeValue = window.workingDays[day].startTime;
                        if (timeValue.includes('AM') || timeValue.includes('PM')) {
                            const match = timeValue.match(/(\d+):(\d+)\s*(AM|PM)/i);
                            if (match) {
                                let hours = parseInt(match[1]);
                                const minutes = match[2];
                                const period = match[3].toUpperCase();
                                
                                // Convert to 24-hour format
                                if (period === 'PM' && hours < 12) hours += 12;
                                if (period === 'AM' && hours === 12) hours = 0;
                                
                                timeValue = `${hours.toString().padStart(2, '0')}:${minutes}`;
                            }
                        }
                        startTimeInput.value = timeValue;
                    } else {
                        startTimeInput.value = "08:00";
                    }
                    startTimeInput.addEventListener('change', () => {
                        // Update workingDays with the new start time
                        if (window.workingDays && window.workingDays[day]) {
                            // Convert from "08:00" to "8:00 AM" format
                            const timeInput = startTimeInput.value;
                            if (timeInput) {
                                const [hours, minutes] = timeInput.split(':').map(Number);
                                const period = hours >= 12 ? 'PM' : 'AM';
                                const displayHours = hours % 12 || 12;
                                window.workingDays[day].startTime = `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
                            }
                        }
                        recalculateScheduleTimes(day);
                    });
                }
                
                // Fix for errors in settings.js validation functions
                // This ensures our time format is compatible with their validators
                if (window.convertTimeToMinutes || window.calculateEndTime || window.validateTimeSettings) {
                    // Patch the validation functions to handle undefined gracefully
                    try {
                        // Safety patch for convertTimeToMinutes
                        if (window.convertTimeToMinutes) {
                            const originalConvert = window.convertTimeToMinutes;
                            window.convertTimeToMinutes = function(timeStr) {
                                if (!timeStr || typeof timeStr !== 'string') {
                                    console.log('Invalid time passed to convertTimeToMinutes:', timeStr);
                                    return 8 * 60; // Default to 8:00 AM (8 hours * 60 minutes)
                                }
                                return originalConvert.call(this, timeStr);
                            };
                        }
                        
                        // Safety patch for validation function
                        if (window.validateTimeSettings) {
                            const originalValidate = window.validateTimeSettings;
                            window.validateTimeSettings = function(day, settings) {
                                try {
                                    return originalValidate.call(this, day, settings);
                                } catch (err) {
                                    console.log('Time validation error suppressed:', err);
                                    return true; // Consider it valid to avoid errors
                                }
                            };
                        }
                    } catch (e) {
                        console.log('Error while patching time functions:', e);
                    }
                }
                
                // Direct job count update handler to ensure settingsWorkingDays gets updated
                if (window.settingsWorkingDays || window.updateSettingsWorkingDays) {
                    // Add job count observer
                    const jobObserver = new MutationObserver((mutations) => {
                        // Check if we have any schedule items
                        const schedulePreview = document.querySelector(`#${day}-schedule-preview`);
                        if (!schedulePreview) return;
                        
                        // Count the number of job divs (excluding breaks and done)
                        const jobDivs = Array.from(schedulePreview.querySelectorAll('.bg-blue-100'));
                        const jobCount = jobDivs.length;
                        
                        // Update the workingDays object directly
                        console.log(`Schedule mutation detected, setting ${day} jobsPerDay to ${jobCount}`);
                        
                        if (window.settingsWorkingDays) {
                            if (window.settingsWorkingDays[day] && window.settingsWorkingDays[day].jobsPerDay !== jobCount) {
                                console.log(`Directly updating settingsWorkingDays[${day}].jobsPerDay to ${jobCount}`);
                                window.settingsWorkingDays[day].jobsPerDay = jobCount;
                            }
                        }
                        
                        if (window.updateSettingsWorkingDays) {
                            window.updateSettingsWorkingDays(day, 'jobsPerDay', jobCount);
                        }
                    });
                    
                    // Start observing the preview container
                    const scheduleContainer = document.querySelector(`[data-day-settings="${day}"] .bg-white.rounded-xl`);
                    if (scheduleContainer) {
                        jobObserver.observe(scheduleContainer, {
                            childList: true,
                            subtree: true
                        });
                    }
                }
                
                // Attach job count button handlers
                const jobButtons = daySettings.querySelectorAll(`[data-jobs][data-day="${day}"]`);
                jobButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const jobCount = parseInt(this.getAttribute('data-jobs'));
                        
                        // Update UI - highlight selected button
                        jobButtons.forEach(btn => {
                            btn.classList.remove('bg-blue-100', 'border-blue-400');
                            btn.classList.add('hover:bg-blue-50');
                        });
                        this.classList.add('bg-blue-100', 'border-blue-400');
                        this.classList.remove('hover:bg-blue-50');
                        
                        // DIRECT JOB COUNT UPDATE: Use the dedicated function for reliable job count setting
                        console.log(`DIRECT JOB COUNT CALL: Using setJobCount(${day}, ${jobCount})`);
                        
                        if (window.setJobCount) {
                            // Use our specialized direct setter that ensures save happens
                            window.setJobCount(day, jobCount);
                            
                            // Update the schedule preview based on the new job count
                            updateSchedulePreview(day, jobCount);
                            
                            // Recalculate times to ensure accuracy
                            setTimeout(() => {
                                recalculateScheduleTimes(day);
                            }, 50);
                        } else {
                            // Fallback to the previous methods
                            console.log(`DIRECT JOB COUNT: setJobCount not found, using fallbacks`);
                            
                            // Debug info
                            console.log(`Job button clicked for ${day}: setting job count to ${jobCount}`);
                            console.log(`Available settings objects:`, {
                                settingsWorkingDays: window.settingsWorkingDays ? 'FOUND' : 'NOT FOUND',
                                updateSettingsWorkingDays: typeof window.updateSettingsWorkingDays === 'function' ? 'FOUND' : 'NOT FOUND',
                                getSettingsWorkingDays: typeof window.getSettingsWorkingDays === 'function' ? 'FOUND' : 'NOT FOUND'
                            });
                            
                            // Try all possible methods to update the job count
                            let updated = false;
                            
                            // Method 1: Direct access via settingsWorkingDays
                            if (window.settingsWorkingDays && window.settingsWorkingDays[day]) {
                                window.settingsWorkingDays[day].jobsPerDay = jobCount;
                                console.log(`Updated job count via settingsWorkingDays: ${day}.jobsPerDay = ${jobCount}`);
                                updated = true;
                                
                                // Update job durations array
                                if (!window.settingsWorkingDays[day].jobDurations || 
                                    window.settingsWorkingDays[day].jobDurations.length !== jobCount) {
                                    // Preserve existing durations when possible
                                    const oldDurations = window.settingsWorkingDays[day].jobDurations || [];
                                    window.settingsWorkingDays[day].jobDurations = Array(jobCount).fill(0).map((_, i) => 
                                        i < oldDurations.length ? oldDurations[i] : 210); // 3.5 hours default
                                    
                                    console.log(`Updated job durations array for ${day}:`, window.settingsWorkingDays[day].jobDurations);
                                }
                                
                                // Update break durations array
                                if (!window.settingsWorkingDays[day].breakDurations || 
                                    window.settingsWorkingDays[day].breakDurations.length !== jobCount - 1) {
                                    const oldBreaks = window.settingsWorkingDays[day].breakDurations || [];
                                    window.settingsWorkingDays[day].breakDurations = Array(jobCount - 1).fill(0).map((_, i) => 
                                        i < oldBreaks.length ? oldBreaks[i] : 60); // 1 hour default
                                    
                                    console.log(`Updated break durations array for ${day}:`, window.settingsWorkingDays[day].breakDurations);
                                }
                            }
                            
                            // Method 2: Use the update function if available
                            if (window.updateSettingsWorkingDays && !updated) {
                                updated = window.updateSettingsWorkingDays(day, 'jobsPerDay', jobCount);
                                if (updated) {
                                    console.log(`Updated job count via updateSettingsWorkingDays function: ${day}.jobsPerDay = ${jobCount}`);
                                }
                            }
                            
                            // Method 3: Emergency direct creation if all else fails
                            if (!updated) {
                                console.warn("WARNING: No workingDays object found. Creating emergency direct access.");
                                if (!window.settingsWorkingDays) {
                                    window.settingsWorkingDays = {};
                                }
                                if (!window.settingsWorkingDays[day]) {
                                    window.settingsWorkingDays[day] = {
                                        isWorking: true,
                                        startTime: '8:00 AM',
                                        jobsPerDay: jobCount,
                                        breakTime: 60,
                                        breakDurations: Array(jobCount - 1).fill(60),
                                        jobDurations: Array(jobCount).fill(210)
                                    };
                                } else {
                                    window.settingsWorkingDays[day].jobsPerDay = jobCount;
                                    window.settingsWorkingDays[day].jobDurations = Array(jobCount).fill(210);
                                    window.settingsWorkingDays[day].breakDurations = Array(jobCount - 1).fill(60);
                                }
                                console.log(`Created emergency direct access to settings for ${day}`);
                            }
                            
                            // Save settings
                            if (window.triggerSettingsSave) {
                                console.log('Triggering settings save...');
                                window.triggerSettingsSave();
                            } else if (typeof window.validateAndSaveSettings === 'function') {
                                console.log('Calling validateAndSaveSettings()...');
                                window.validateAndSaveSettings();
                            } else {
                                console.error('No save function available!');
                            }
                        }
                        
                        // Update schedule preview based on job count
                        updateSchedulePreview(day, jobCount);
                        
                        // Debug: Print state after update
                        if (window.settingsWorkingDays) {
                            console.log(`FINAL STATE - day ${day}:`, JSON.stringify(window.settingsWorkingDays[day]));
                        }
                    });
                });
            }
            
            // Initialize all days that are checked (working days)
            weekdays.forEach(day => {
                const dayToggle = document.querySelector(`[data-day-toggle="${day}"]`);
                if (dayToggle && dayToggle.checked) {
                    createDayUI(day);
                }
                
                // Add event listener to toggle button
                if (dayToggle) {
                    dayToggle.addEventListener('change', function() {
                        const daySettings = document.querySelector(`[data-day-settings="${day}"]`);
                        if (daySettings) {
                            if (this.checked) {
                                daySettings.classList.remove('hidden');
                                createDayUI(day); // Create UI when day is enabled
                                recalculateScheduleTimes(day);
                            } else {
                                daySettings.classList.add('hidden');
                            }
                        }
                    });
                }
            });
            
            // Time adjustment handler
            function handleTimeAdjustment(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const button = e.currentTarget;
                const action = button.getAttribute('data-action');
                const target = button.getAttribute('data-target');
                const isIncrease = action === 'increase-time';
                
                const container = button.closest('.flex-1');
                // Find the duration element - could be either blue (job) or gray (break)
                const durationEl = container.querySelector('.text-blue-700') || 
                                container.querySelector('.text-sm.font-normal');
                
                if (!durationEl) {
                    console.error('Could not find duration element');
                    return;
                }
                
                // Extract the numeric value from text like "2.5 hours"
                let timeText = durationEl.textContent;
                let durationMatch = timeText.match(/(\d+(\.\d+)?)/);
                
                if (!durationMatch) {
                    console.error('Could not parse duration:', timeText);
                    return;
                }
                
                let hours = parseFloat(durationMatch[0]);
                console.log('Current duration:', hours);
                
                if (isIncrease && hours < 5) {
                    hours += 0.5;
                } else if (!isIncrease && hours > 0.5) {
                    hours -= 0.5;
                }
                
                console.log('New duration:', hours);
                durationEl.textContent = hours + (hours === 1 ? " hour" : " hours");
                
                // Update the visual duration indicator
                const maxHours = 5; // Maximum possible duration
                const progressBar = container.querySelector('.bg-blue-500, .bg-gray-500');
                if (progressBar) {
                    progressBar.style.width = `${(hours/maxHours)*100}%`;
                }
                
                const day = target.split('-')[0];
                const itemType = target.split('-')[1]; // 'job' or 'break'
                const itemIndex = parseInt(target.split('-')[2]) - 1; // Convert to 0-based index
                
                // Update workingDays object with the new duration
                if (window.workingDays && window.workingDays[day]) {
                    // Convert hours to minutes for the workingDays object
                    const durationMinutes = Math.round(hours * 60);
                    
                    if (itemType === 'job' && window.workingDays[day].jobDurations) {
                        // Update job duration
                        if (itemIndex >= 0 && itemIndex < window.workingDays[day].jobDurations.length) {
                            window.workingDays[day].jobDurations[itemIndex] = durationMinutes;
                            console.log(`Updated ${day} job ${itemIndex+1} duration to ${durationMinutes} minutes`);
                        }
                    } else if (itemType === 'break' && window.workingDays[day].breakDurations) {
                        // Update break duration
                        if (itemIndex >= 0 && itemIndex < window.workingDays[day].breakDurations.length) {
                            window.workingDays[day].breakDurations[itemIndex] = durationMinutes;
                            console.log(`Updated ${day} break ${itemIndex+1} duration to ${durationMinutes} minutes`);
                        }
                    }
                    
                    // Trigger save with proper notification
                    if (window.triggerSettingsSave) {
                        window.triggerSettingsSave();
                    } else if (typeof window.validateAndSaveSettings === 'function') {
                        window.validateAndSaveSettings();
                    }
                }
                
                // Recalculate all times in the schedule
                recalculateScheduleTimes(day);
            }
            
            // Function to update schedule preview based on job count
            function updateSchedulePreview(day, jobCount) {
                const schedulePreview = document.querySelector(`#${day}-schedule-preview`);
                if (!schedulePreview) return;
                
                console.log(`Updating schedule for ${day} with ${jobCount} jobs`);
                
                // Get the current start time
                const startTimeInput = document.querySelector(`[data-start-time="${day}"]`);
                const startTime = startTimeInput ? startTimeInput.value : "08:00";
                let [hours, minutes] = startTime.split(':').map(Number);
                let currentMinutes = hours * 60 + minutes;
                let startMinutes = currentMinutes; // Save start time for total hours calculation
                
                // Clear existing schedule
                schedulePreview.innerHTML = '';
                
                // For calculating proportional width of duration bars
                const maxHours = 5; // Maximum possible hours for a job
                
                // Track total working hours (excluding breaks)
                let totalWorkingHours = 0;
                
                // Generate HTML for schedule based on job count
                let html = '';
                
                // First job (always present)
                const firstJobHours = 3.5;
                totalWorkingHours += firstJobHours;
                
                html += `
                    <div class="flex items-center mb-6">
                        <div class="w-20 text-base font-medium text-blue-600">${formatTime(currentMinutes)}</div>
                        <div class="flex-1 py-3 px-3 bg-blue-100 rounded-lg flex items-center text-blue-800 font-medium border-l-4 border-blue-500 shadow-sm">
                            <div class="flex-1">
                                <div class="text-base">First Job</div>
                                <div class="text-sm font-normal text-blue-700">${firstJobHours} hours</div>
                                <div class="mt-2 bg-blue-200 rounded-full h-2.5 overflow-hidden">
                                    <div class="bg-blue-500 h-full rounded-full" style="width: ${(firstJobHours/maxHours)*100}%"></div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 border border-blue-200" data-action="decrease-time" data-target="${day}-job-1">
                                    <span class="text-blue-500 font-medium">-</span>
                                </button>
                                <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 border border-blue-200" data-action="increase-time" data-target="${day}-job-1">
                                    <span class="text-blue-500 font-medium">+</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update current time
                currentMinutes += firstJobHours * 60;
                
                // Add breaks and jobs based on job count
                if (jobCount >= 2) {
                    // Add break after first job
                    const breakHours = 1;
                    html += `
                        <div class="flex items-center mb-6">
                            <div class="w-20 text-base font-medium text-blue-600">${formatTime(currentMinutes)}</div>
                            <div class="flex-1 py-3 px-3 bg-gray-100 rounded-lg flex items-center text-gray-700 border-l-4 border-gray-400 shadow-sm">
                                <div class="flex-1">
                                    <div class="text-base">Break</div>
                                    <div class="text-sm font-normal">${breakHours} hours</div>
                                    <div class="mt-2 bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                        <div class="bg-gray-500 h-full rounded-full" style="width: ${(breakHours/maxHours)*100}%"></div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-gray-50 border border-gray-200" data-action="decrease-time" data-target="${day}-break-1">
                                        <span class="text-gray-500 font-medium">-</span>
                                    </button>
                                    <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-gray-50 border border-gray-200" data-action="increase-time" data-target="${day}-break-1">
                                        <span class="text-gray-500 font-medium">+</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update current time
                    currentMinutes += breakHours * 60;
                    
                    // Add second job
                    const secondJobHours = 3.5;
                    totalWorkingHours += secondJobHours;
                    
                    html += `
                        <div class="flex items-center mb-6">
                            <div class="w-20 text-base font-medium text-blue-600">${formatTime(currentMinutes)}</div>
                            <div class="flex-1 py-3 px-3 bg-blue-100 rounded-lg flex items-center text-blue-800 font-medium border-l-4 border-blue-500 shadow-sm">
                                <div class="flex-1">
                                    <div class="text-base">Second Job</div>
                                    <div class="text-sm font-normal text-blue-700">${secondJobHours} hours</div>
                                    <div class="mt-2 bg-blue-200 rounded-full h-2.5 overflow-hidden">
                                        <div class="bg-blue-500 h-full rounded-full" style="width: ${(secondJobHours/maxHours)*100}%"></div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 border border-blue-200" data-action="decrease-time" data-target="${day}-job-2">
                                        <span class="text-blue-500 font-medium">-</span>
                                    </button>
                                    <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 border border-blue-200" data-action="increase-time" data-target="${day}-job-2">
                                        <span class="text-blue-500 font-medium">+</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update current time
                    currentMinutes += secondJobHours * 60;
                }
                
                if (jobCount >= 3) {
                    // Add break after second job
                    const breakHours = 1;
                    html += `
                        <div class="flex items-center mb-6">
                            <div class="w-20 text-base font-medium text-blue-600">${formatTime(currentMinutes)}</div>
                            <div class="flex-1 py-3 px-3 bg-gray-100 rounded-lg flex items-center text-gray-700 border-l-4 border-gray-400 shadow-sm">
                                <div class="flex-1">
                                    <div class="text-base">Break</div>
                                    <div class="text-sm font-normal">${breakHours} hours</div>
                                    <div class="mt-2 bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                        <div class="bg-gray-500 h-full rounded-full" style="width: ${(breakHours/maxHours)*100}%"></div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-gray-50 border border-gray-200" data-action="decrease-time" data-target="${day}-break-2">
                                        <span class="text-gray-500 font-medium">-</span>
                                    </button>
                                    <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-gray-50 border border-gray-200" data-action="increase-time" data-target="${day}-break-2">
                                        <span class="text-gray-500 font-medium">+</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update current time
                    currentMinutes += breakHours * 60;
                    
                    // Add third job
                    const thirdJobHours = 3.5;
                    totalWorkingHours += thirdJobHours;
                    
                    html += `
                        <div class="flex items-center mb-6">
                            <div class="w-20 text-base font-medium text-blue-600">${formatTime(currentMinutes)}</div>
                            <div class="flex-1 py-3 px-3 bg-blue-100 rounded-lg flex items-center text-blue-800 font-medium border-l-4 border-blue-500 shadow-sm">
                                <div class="flex-1">
                                    <div class="text-base">Third Job</div>
                                    <div class="text-sm font-normal text-blue-700">${thirdJobHours} hours</div>
                                    <div class="mt-2 bg-blue-200 rounded-full h-2.5 overflow-hidden">
                                        <div class="bg-blue-500 h-full rounded-full" style="width: ${(thirdJobHours/maxHours)*100}%"></div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 border border-blue-200" data-action="decrease-time" data-target="${day}-job-3">
                                        <span class="text-blue-500 font-medium">-</span>
                                    </button>
                                    <button class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm hover:bg-blue-50 border border-blue-200" data-action="increase-time" data-target="${day}-job-3">
                                        <span class="text-blue-500 font-medium">+</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update current time
                    currentMinutes += thirdJobHours * 60;
                }
                
                // Add "Done" at the end
                html += `
                    <div class="flex items-center mb-6">
                        <div class="w-20 text-base font-medium text-blue-600">${formatTime(currentMinutes)}</div>
                        <div class="flex-1 py-3 px-3 bg-green-100 rounded-lg flex items-center text-green-700 border-l-4 border-green-500 shadow-sm">
                            <div class="flex-1">
                                <div class="text-base">Done</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update the schedule preview
                schedulePreview.innerHTML = html;
                
                // Reattach time adjustment handlers to the new buttons
                const buttons = document.querySelectorAll('[data-action="increase-time"], [data-action="decrease-time"]');
                buttons.forEach(button => {
                    button.removeEventListener('click', handleTimeAdjustment);
                    button.addEventListener('click', handleTimeAdjustment);
                });
                
                // Recalculate times to ensure the total hours summary is created/updated
                recalculateScheduleTimes(day);
            }
            
            // Core time calculation function
            function recalculateScheduleTimes(day) {
                const schedulePreview = document.querySelector(`[data-day-settings="${day}"] .bg-white.rounded-xl`);
                if (!schedulePreview) {
                    console.error(`Schedule preview not found for ${day}`);
                    const daySettings = document.querySelector(`[data-day-settings="${day}"]`);
                    if (daySettings) {
                        const scheduleContainer = daySettings.querySelector(`.bg-white.p-4.rounded-xl`);
                        if (scheduleContainer) {
                            schedulePreview = scheduleContainer;
                        } else {
                            return; // Can't find the schedule container
                        }
                    } else {
                        return; // Can't find day settings
                    }
                }
                
                console.log('Recalculating schedule times for', day);
                
                const startTimeInput = document.querySelector(`[data-start-time="${day}"]`);
                const startTime = startTimeInput ? startTimeInput.value : "08:00";
                console.log('Start time:', startTime);
                
                let [hours, minutes] = startTime.split(':').map(Number);
                let currentMinutes = hours * 60 + minutes;
                const startMinutes = currentMinutes; // Save initial time for total calculation
                
                // Track total working hours (excluding breaks)
                let totalWorkingHours = 0;
                
                // Use more specific selector to only get the direct children schedule items
                const scheduleItems = Array.from(document.querySelectorAll(`#${day}-schedule-preview > .flex.items-center`));
                console.log(`Found ${scheduleItems.length} schedule items for ${day}`);
                
                if (scheduleItems.length === 0) {
                    console.warn(`No schedule items found for ${day}, trying alternative selector`);
                    // Fallback selector if the ID-based selector doesn't work
                    const fallbackItems = Array.from(schedulePreview.children).filter(el => 
                        el.classList.contains('flex') && el.classList.contains('items-center'));
                    
                    if (fallbackItems.length > 0) {
                        console.log('Found', fallbackItems.length, 'items with fallback selector');
                        processScheduleItems(fallbackItems, currentMinutes);
                    } else {
                        console.error(`Could not find any schedule items for ${day}`);
                    }
                } else {
                    processScheduleItems(scheduleItems, currentMinutes);
                }
                
                function processScheduleItems(items, startMinutes) {
                    let currentMinutes = startMinutes;
                    let localTotalWorkingHours = 0; // Local variable to track working hours
                    
                    // Set start time for first item
                    if (items[0]) {
                        const timeDisplay = items[0].querySelector('.w-20');
                        if (timeDisplay) {
                            timeDisplay.textContent = formatTime(currentMinutes);
                            console.log(`Set first item time for ${day} to ${timeDisplay.textContent}`);
                        }
                    }
                    
                    // Process each item sequentially
                    for (let i = 0; i < items.length - 1; i++) {
                        const currentItem = items[i];
                        const nextItem = items[i + 1];
                        
                        // Get duration from current item - could be job or break
                        const durationEl = currentItem.querySelector('.text-blue-700') || 
                                          currentItem.querySelector('.text-sm.font-normal:not(.text-blue-700)');
                        
                        if (!durationEl || !nextItem) {
                            console.log(`Missing duration element or next item for index ${i} on ${day}`);
                            continue;
                        }
                        
                        // Parse duration (e.g., "3 hours" -> 3)
                        const durationText = durationEl.textContent;
                        const durationMatch = durationText.match(/(\d+(\.\d+)?)/);
                        
                        if (!durationMatch) {
                            console.log(`Could not parse duration from ${durationText} on ${day}`);
                            continue;
                        }
                        
                        const durationHours = parseFloat(durationMatch[0]);
                        console.log(`Item ${i} duration on ${day}:`, durationHours, 'hours');
                        
                        // Track total working hours (jobs only, not breaks)
                        if (currentItem.querySelector('.bg-blue-100')) {
                            localTotalWorkingHours += durationHours;
                        }
                        
                        // Add duration to current time
                        currentMinutes += durationHours * 60;
                        
                        // Update next item's start time
                        const nextTimeDisplay = nextItem.querySelector('.w-20');
                        if (nextTimeDisplay) {
                            const newTime = formatTime(currentMinutes);
                            nextTimeDisplay.textContent = newTime;
                            console.log(`Next item (${i+1}) time for ${day} set to:`, newTime);
                        }
                    }
                    
                    // After updating all items, calculate and update total hours
                    const totalDurationMinutes = currentMinutes - startMinutes;
                    const totalHours = totalDurationMinutes / 60;
                    console.log(`Total duration for ${day}:`, totalHours.toFixed(1), 'hours');
                    console.log(`Total working hours for ${day}:`, localTotalWorkingHours.toFixed(1), 'hours');
                    
                    // Remove any existing total hours summary
                    const existingSummary = document.querySelector(`#${day}-total-hours`);
                    if (existingSummary) {
                        existingSummary.remove();
                    }
                    
                    // Create a new total hours summary
                    const summaryEl = document.createElement('div');
                    summaryEl.id = `${day}-total-hours`;
                    summaryEl.className = 'flex items-center mt-4';
                    
                    // Determine workload category
                    let workloadClass = 'text-yellow-600';
                    let workloadText = 'Medium workday';
                    let workloadIcon = 'fa-briefcase';
                    
                    if (totalHours <= 6) {
                        workloadClass = 'text-green-600';
                        workloadText = 'Light workday';
                        workloadIcon = 'fa-leaf';
                    } else if (totalHours >= 9) {
                        workloadClass = 'text-red-600';
                        workloadText = 'Heavy workday';
                        workloadIcon = 'fa-dumbbell';
                    }
                    
                    summaryEl.innerHTML = `
                        <div class="w-20"></div>
                        <div class="flex-1 py-4 px-4 bg-blue-50 rounded-lg border border-blue-200 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-base font-medium text-blue-900">Total Working Hours</div>
                                    <div class="text-sm text-blue-700 mt-1">${localTotalWorkingHours.toFixed(1)} hours of cleaning work</div>
                                </div>
                                <div class="text-xl font-bold ${workloadClass} flex items-center">
                                    <i class="fas ${workloadIcon} mr-2"></i>
                                    ${totalHours.toFixed(1)} hrs
                                </div>
                            </div>
                            <div class="mt-3 bg-blue-100 rounded-full h-3 overflow-hidden">
                                <div class="bg-blue-500 h-full rounded-full" style="width: ${Math.min(totalHours/12 * 100, 100)}%"></div>
                            </div>
                            <div class="mt-2 text-xs text-blue-600">${workloadText}</div>
                        </div>
                    `;
                    
                    schedulePreview.appendChild(summaryEl);
                }
            }
            
            // Format minutes to "H:MM AM/PM"
            function formatTime(totalMinutes) {
                let hours = Math.floor(totalMinutes / 60);
                let minutes = totalMinutes % 60;
                
                const period = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                
                return `${hours}:${minutes.toString().padStart(2, '0')} ${period}`;
            }
        });
    </script>

    <!-- Fix for job count persistence issues -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('JOB COUNT FIX: Adding job count persistence patch');
            
            // Wait for settings.js to fully initialize
            setTimeout(() => {
                // Check if we can access the settings object methods
                if (typeof window.saveSettings === 'function' && typeof window.loadSettings === 'function') {
                    console.log('JOB COUNT FIX: Found settings functions, patching...');
                    
                    // Save the original functions
                    const originalSaveSettings = window.saveSettings;
                    // NOTE: We've updated the loading process in settings.js, so we don't need to override loadSettings anymore
                    // const originalLoadSettings = window.loadSettings;
                    
                    // Override save settings to make sure job counts are included
                    window.saveSettings = function() {
                        console.log('JOB COUNT FIX: saveSettings called - ensuring job counts are correct');
                        
                        // Make sure settingsWorkingDays is accessible and synced with workingDays
                        if (window.settingsWorkingDays) {
                            try {
                                // Loop through all days
                                ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
                                    if (window.settingsWorkingDays[day]) {
                                        // Get the current job count from the UI
                                        let jobCount = window.settingsWorkingDays[day].jobsPerDay;
                                        if (!jobCount || jobCount < 1 || jobCount > 3) {
                                            // Default to 2 if invalid
                                            jobCount = 2;
                                        }
                                        
                                        console.log(`JOB COUNT FIX: Saving ${day} job count:`, jobCount);
                                        
                                        // Ensure break and job durations arrays match the job count
                                        if (window.settingsWorkingDays[day].jobDurations?.length !== jobCount) {
                                            const oldDurations = window.settingsWorkingDays[day].jobDurations || [];
                                            window.settingsWorkingDays[day].jobDurations = Array(jobCount).fill(0).map((_, i) => 
                                                i < oldDurations.length ? oldDurations[i] : 210);
                                        }
                                        
                                        if (window.settingsWorkingDays[day].breakDurations?.length !== jobCount - 1) {
                                            const oldBreaks = window.settingsWorkingDays[day].breakDurations || [];
                                            window.settingsWorkingDays[day].breakDurations = Array(jobCount - 1).fill(0).map((_, i) => 
                                                i < oldBreaks.length ? oldBreaks[i] : 60);
                                        }
                                    }
                                });
                            } catch (err) {
                                console.error('JOB COUNT FIX: Error in pre-save hook:', err);
                            }
                        }
                        
                        // Call original save
                        return originalSaveSettings.apply(this, arguments);
                    };
                    
                    /* 
                    // NOTE: Disabling this override as we now have a more comprehensive fix in settings.js
                    // Override load settings to ensure job counts are properly initialized
                    window.loadSettings = function() {
                        console.log('JOB COUNT FIX: loadSettings called - will verify job counts after load');
                        
                        // Call original load
                        const result = originalLoadSettings.apply(this, arguments);
                        
                        // After settings are loaded, set a timeout to verify and fix job counts
                        setTimeout(() => {
                            console.log('JOB COUNT FIX: Verifying loaded job counts');
                            
                            // Verify for each day
                            ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
                                const dayPanel = document.querySelector(`[data-day-settings="${day}"]`);
                                
                                if (dayPanel) {
                                    try {
                                        // Get saved job count from settings
                                        let jobCount = 2; // Default
                                        
                                        if (window.settingsWorkingDays && window.settingsWorkingDays[day]) {
                                            jobCount = window.settingsWorkingDays[day].jobsPerDay || 2;
                                            console.log(`JOB COUNT FIX: Loaded job count for ${day}:`, jobCount);
                                            
                                            // Ensure it's valid
                                            if (jobCount < 1 || jobCount > 3) {
                                                jobCount = 2;
                                                window.settingsWorkingDays[day].jobsPerDay = 2;
                                            }
                                        }
                                        
                                        // Try to click the corresponding job button to apply the count
                                        const jobButton = dayPanel.querySelector(`[data-jobs="${jobCount}"]`);
                                        if (jobButton) {
                                            console.log(`JOB COUNT FIX: Clicking job ${jobCount} button for ${day}`);
                                            // Use a timeout to ensure the DOM is ready
                                            setTimeout(() => {
                                                jobButton.click();
                                            }, 100);
                                        } else {
                                            console.warn(`JOB COUNT FIX: Could not find job button for count ${jobCount} on ${day}`);
                                        }
                                    } catch (err) {
                                        console.error(`JOB COUNT FIX: Error processing ${day}:`, err);
                                    }
                                }
                            });
                        }, 500);
                        
                        return result;
                    };
                    */
                    
                    console.log('JOB COUNT FIX: Successfully patched save function');
                }
            }, 1000);
        });
    </script>

    <!-- Trigger settings loading on page load -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Allow some time for Firebase and settings.js to initialize
            setTimeout(() => {
                console.log('CRITICAL LOAD FIX: Triggering settings load from page');
                if (typeof window.loadSettingsFromAllLocations === 'function') {
                    console.log('CRITICAL LOAD FIX: Calling loadSettingsFromAllLocations()');
                    window.loadSettingsFromAllLocations();
                } else {
                    console.warn('CRITICAL LOAD FIX: loadSettingsFromAllLocations function not found');
                }
            }, 1500);
        });
    </script>
</body>
</html> 